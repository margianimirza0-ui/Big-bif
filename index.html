<!DOCTYPE html>
<html lang="ka">
<script src="https://cdn.onesignal.com/sdks/web/v16/OneSignalSDK.page.js" defer></script>
<script>
  window.OneSignalDeferred = window.OneSignalDeferred || [];
  OneSignalDeferred.push(async function(OneSignal) {
    await OneSignal.init({
      appId: "98cde065-105b-4035-9b58-a06bbb4c42e2",
    });
  });
</script>






    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Big Bif Pro - Optimized</title>
    
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <link rel="apple-touch-icon" href="icon.png">
    <link rel="manifest" href="manifest.json">

    <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-database-compat.js"></script>

    <style>
        :root { --primary: #2575fc; --secondary: #6a11cb; --success: #38ef7d; --danger: #ff5f6d; --warning: #f2994a; --bg: #000000; }
        body { font-family: -apple-system, BlinkMacSystemFont, sans-serif; background: var(--bg); color: white; margin: 0; padding: 15px; -webkit-tap-highlight-color: transparent; }
        
        .login-logo { font-size: 80px; margin-bottom: 20px; animation: bounce 2s infinite; }
        @keyframes bounce { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-10px); } }

        .card { background: #1a1a1a; padding: 18px; border-radius: 18px; margin-bottom: 15px; border: 1px solid #333; }
        .blue-panel { background: linear-gradient(135deg, var(--secondary) 0%, var(--primary) 100%); padding: 20px; border-radius: 18px; display: flex; gap: 15px; margin-bottom: 15px; }
        .blue-stat-box { flex: 1; text-align: center; }
        .blue-stat-box b { display: block; font-size: 1.6em; margin-top: 5px; }

        input, select { width: 100%; padding: 14px; margin: 8px 0; border: 1px solid #444; border-radius: 12px; font-size: 16px; background: #252525; color: white; box-sizing: border-box; outline: none; }
        input:focus { border-color: var(--primary); }
        
        button { cursor: pointer; border: none; font-weight: bold; transition: 0.2s; border-radius: 12px; width: 100%; padding: 14px; active { transform: scale(0.98); } }
        
        .btn-auth { background: linear-gradient(to right, #ff5f6d, #ffc371); color: white; margin-top: 20px; }
        .btn-buy { background: #34495e; color: white; margin-bottom: 10px; }
        .flex-btns { display: flex; gap: 10px; justify-content: space-between; }
        .btn-sell { background: linear-gradient(to right, #11998e, #38ef7d); color: white; width: 48%; }
        .btn-cons { background: linear-gradient(to right, #f2994a, #f2c94c); color: white; width: 48%; }
        .btn-expense { background: rgba(255, 95, 109, 0.1); color: #ff5f6d; margin-top: 10px; border: 1px solid #ff5f6d; }

        .history-item { border-bottom: 1px solid #333; padding: 12px 5px; position: relative; }
        .history-total { color: #aaa; font-size: 12px; font-weight: bold; margin-top: 4px; }
        .action-btns { position: absolute; right: 2px; top: 10px; display: flex; gap: 5px; }
        .action-btns button { width: auto; padding: 4px 6px; background: none; font-size: 14px; color: white; border: 0.5px solid #444; }

        .type-buy { color: #2575fc !important; font-weight: bold; }
        .type-sell { color: #38ef7d !important; font-weight: bold; }
        .type-cons { color: #f2994a !important; font-weight: bold; }
        .type-exp { color: var(--danger) !important; font-weight: bold; }
        .type-paid { color: #38ef7d !important; opacity: 0.7; }

        .stat-table { width: 100%; border-collapse: collapse; margin-top: 5px; font-size: 13px; }
        .stat-table th { color: #777; text-align: left; padding-bottom: 5px; }
        .stat-table td { padding: 8px 0; border-bottom: 1px solid #222; }

        #modal-overlay { display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.85); z-index:1000; justify-content:center; align-items:center; }
        .modal-content { background:#1a1a1a; width:85%; max-height:70vh; border-radius:20px; padding:20px; border:1px solid #444; overflow-y:auto; }
        
        #loading-overlay { position: fixed; top: 10px; right: 10px; background: var(--primary); padding: 5px 10px; border-radius: 20px; font-size: 10px; display: none; z-index: 2000; }
    </style>
</head>
<body>

<div id="loading-overlay">áƒ›áƒ£áƒ¨áƒáƒ•áƒ“áƒ”áƒ‘áƒ...</div>

<div id="login-screen" style="display:flex; flex-direction:column; align-items:center; justify-content:center; height:95vh;">
    <div class="login-logo">ğŸ…</div>
    <h2 style="margin-top: 0;">Big Bif Pro</h2>
    <div style="width: 85%;">
        <input type="password" id="passInput" placeholder="áƒ¨áƒ”áƒ˜áƒ§áƒ•áƒáƒœáƒ”áƒ— áƒáƒáƒ áƒáƒšáƒ˜" inputmode="numeric">
        <button class="btn-auth" onclick="checkPass()">áƒ¨áƒ”áƒ¡áƒ•áƒšáƒ</button>
    </div>
</div>

<div id="main-content" style="display:none">
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
        <select id="prod" onchange="loadData()" style="width: auto; margin: 0; background: none; border: none; font-weight: bold; color: white;">
            <option value="tomato">ğŸ… áƒáƒáƒ›áƒ˜áƒ“áƒáƒ áƒ˜</option>
            <option value="cucumber">ğŸ¥’ áƒ™áƒ˜áƒ¢áƒ áƒ˜</option>
            <option value="test_product">ğŸ§ª áƒ¢áƒ”áƒ¡áƒ¢áƒ˜áƒ áƒ”áƒ‘áƒ</option> 
        </select>
        <div id="user-info" style="font-size: 12px; color: #777; font-weight: bold;"></div>
    </div>
    
    <div class="blue-panel">
        <div class="blue-stat-box"><span>áƒœáƒáƒ¨áƒ—áƒ˜</span><b id="st-qty">0</b></div>
        <div class="blue-stat-box" style="border-left: 1px solid rgba(255,255,255,0.2); line-height: 1.2;" id="st-rev">0</div>
    </div>

    <div class="card">
        <div style="font-weight: bold; color: #ffc371; margin-bottom: 10px;">ğŸ“… áƒ“áƒ¦áƒ˜áƒ£áƒ áƒ˜ áƒ’áƒáƒ§áƒ˜áƒ“áƒ•áƒ”áƒ‘áƒ˜ (áƒ‘áƒáƒšáƒ 5 áƒ“áƒ¦áƒ”)</div>
        <table class="stat-table">
            <thead><tr><th>áƒ—áƒáƒ áƒ˜áƒ¦áƒ˜</th><th>áƒ™áƒ’</th><th>áƒ›áƒáƒ’áƒ”áƒ‘áƒ</th></tr></thead>
            <tbody id="daily-stats-body"></tbody>
        </table>
    </div>

    <div class="card">
        <button class="btn-buy" onclick="handleAction('buy')">âœš áƒ›áƒ˜áƒ¦áƒ”áƒ‘áƒ</button>
        <div class="flex-btns">
            <input type="number" id="qty" placeholder="áƒ™áƒ’" inputmode="decimal" style="width:48%">
            <input type="number" id="price" placeholder="â‚¾" inputmode="decimal" style="width:48%">
        </div>
        <input type="text" id="note" placeholder="áƒ™áƒšáƒ˜áƒ”áƒœáƒ¢áƒ˜ / áƒ¨áƒ”áƒœáƒ˜áƒ¨áƒ•áƒœáƒ" list="clients" style="width: 100%; padding: 10px; margin-bottom: 10px; border: 1px solid #444; background: #222; color: white; border-radius: 8px;">
        <datalist id="clients"></datalist>

        <div class="flex-btns">
            <button class="btn-sell" onclick="handleAction('sell')">ğŸ’° áƒ’áƒáƒ§áƒ˜áƒ“áƒ•áƒ</button>
            <button class="btn-cons" onclick="handleAction('cons')">ğŸ“ áƒ™áƒáƒœáƒ¡áƒ˜áƒ’áƒœáƒáƒªáƒ˜áƒ</button>
        </div>
        <button class="btn-expense" onclick="handleAction('expense')">â›½ áƒ®áƒáƒ áƒ¯áƒ˜</button>
    </div>

    <div class="card" style="padding: 0; overflow: hidden;">
        <div id="total-summary" style="background: #2ecc71; padding: 12px; text-align: center; font-weight: bold;">áƒ›áƒáƒ’áƒ”áƒ‘áƒ: 0.00 â‚¾</div>
        <div id="debt-summary" onclick="toggleModal(true)" style="background: #e74c3c; padding: 12px; text-align: center; font-weight: bold; cursor:pointer;">áƒ•áƒáƒšáƒ”áƒ‘áƒ˜ (áƒœáƒáƒ®áƒ•áƒ) ğŸ”</div>
        <input type="text" id="histSearch" placeholder="ğŸ” áƒ«áƒ”áƒ‘áƒœáƒ áƒ˜áƒ¡áƒ¢áƒáƒ áƒ˜áƒáƒ¨áƒ˜..." oninput="renderHistory()" style="margin: 10px; width: calc(100% - 20px);">
        <div id="hist" style="max-height: 400px; overflow-y: auto; padding: 10px;"></div>
    </div>
</div>

<div id="modal-overlay" onclick="toggleModal(false)">
    <div class="modal-content" onclick="event.stopPropagation()">
        <h3 style="margin-top:0; color:#ffc371;">áƒ•áƒáƒšáƒ”áƒ‘áƒ˜áƒ¡ áƒ¡áƒ˜áƒ</h3>
        <div id="modal-debt-list"></div>
        <button onclick="toggleModal(false)" style="width:100%; margin-top:20px; background:#444; color:white;">áƒ“áƒáƒ®áƒ£áƒ áƒ•áƒ</button>
    </div>
</div>

<script>
    // --- 1. áƒ™áƒáƒœáƒ¤áƒ˜áƒ’áƒ£áƒ áƒáƒªáƒ˜áƒ ---
    const firebaseConfig = { 
        apiKey: "AIzaSyBvMYT8rjNS3LHAggreip_VAxSG58-s53U", 
        databaseURL: "https://big-bif-default-rtdb.firebaseio.com", 
        projectId: "big-bif" 
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    // áƒ›áƒáƒ›áƒ®áƒ›áƒáƒ áƒ”áƒ‘áƒšáƒ”áƒ‘áƒ˜áƒ¡ áƒ¡áƒ˜áƒ
    const USERS = {
        "7777": { name: "áƒ›áƒ˜áƒ áƒ–áƒ áƒáƒ“áƒ›áƒ˜áƒœáƒ˜", role: "admin" },
        "1111": { name: "áƒ’áƒ˜áƒáƒ áƒ’áƒ˜", role: "user" },
        "2222": { name: "áƒ‘áƒáƒ—áƒ", role: "user" },
        "3333": { name: "áƒ£áƒªáƒœáƒáƒ‘áƒ˜", role: "user" }
    };

    const notifySound = new Audio('https://assets.mixkit.co/active_storage/sfx/2358/2358-preview.mp3');
    
    let isAdmin = false, lastKey = null, isInitialLoad = true, currentUser = "";
    let visibleCount = 50; 
    let currentData = { stock: 0, profit: 0, debt: 0, revenue: 0, history: {}, cost: 0, total_cost_value: 0 };

    // --- 2. áƒáƒ•áƒ¢áƒáƒ áƒ˜áƒ–áƒáƒªáƒ˜áƒ ---
    function checkPass() {
        const p = document.getElementById('passInput').value;
        const user = USERS[p];

        if (user) {
            isAdmin = (user.role === "admin");
            start(user.name);
        } else {
            alert("áƒáƒ áƒáƒ¡áƒ¬áƒáƒ áƒ˜ áƒáƒáƒ áƒáƒšáƒ˜!");
            document.getElementById('passInput').value = "";
        }
    }

    function start(userName) {
        currentUser = userName;
        document.getElementById('login-screen').style.display = 'none';
        document.getElementById('main-content').style.display = 'block';
        document.getElementById('user-info').innerText = "ğŸ‘¤ " + currentUser;
        loadData();
        updateClientList();
    }

    function toggleLoading(show) {
        document.getElementById('loading-overlay').style.display = show ? 'block' : 'none';
    }

    // --- 3. áƒ›áƒáƒœáƒáƒªáƒ”áƒ›áƒ”áƒ‘áƒ˜áƒ¡ áƒ›áƒáƒ áƒ—áƒ•áƒ ---
    function loadData() {
        const p = document.getElementById('prod').value;
        toggleLoading(true);
        db.ref('inventory/' + p).on('value', (snap) => {
            const data = snap.val();
            if (data) {
                const keys = Object.keys(data.history || {}).sort((a,b) => data.history[a].timestamp - data.history[b].timestamp);
                const newestKey = keys[keys.length - 1];
                
                if (!isInitialLoad && newestKey && newestKey !== lastKey) {
                    const entry = data.history[newestKey];
                    sendNotify(`ğŸ”” ${entry.type}`, `${entry.qty} áƒ™áƒ’ - ${entry.note || ''}`);
                    lastKey = newestKey;
                }
                if(isInitialLoad) lastKey = newestKey;
                isInitialLoad = false;
                currentData = data; 
                updateClientList();
            } else {
                currentData = { stock: 0, profit: 0, debt: 0, revenue: 0, history: {}, cost: 0, total_cost_value: 0 };
            }
            updateUI();
            toggleLoading(false);
        });
    }

    function getFormattedTime(ts) {
        const d = ts ? new Date(ts) : new Date();
        return d.toLocaleString('ka-GE', {hour12:false});
    }

    function getDateOnly(ts) {
        const d = ts ? new Date(ts) : new Date();
        return d.toLocaleDateString('ka-GE');
    }

    // --- 4. áƒ›áƒáƒ¥áƒ›áƒ”áƒ“áƒ”áƒ‘áƒ”áƒ‘áƒ˜áƒ¡ áƒ“áƒáƒ›áƒ£áƒ¨áƒáƒ•áƒ”áƒ‘áƒ ---
    async function handleAction(actionType) {
        const q = Number(document.getElementById('qty').value);
        const pr = Number(document.getElementById('price').value) || 0;
        const note = document.getElementById('note').value;
        
        if(!q) return alert("áƒ¨áƒ”áƒ˜áƒ§áƒ•áƒáƒœáƒ”áƒ— áƒ áƒáƒáƒ“áƒ”áƒœáƒáƒ‘áƒ!");
        if(actionType !== 'expense' && (actionType === 'sell' || actionType === 'cons') && currentData.stock < q) {
            return alert("áƒ›áƒáƒ áƒáƒ’áƒ˜ áƒáƒ áƒáƒ¡áƒáƒ™áƒ›áƒáƒ áƒ˜áƒ¡áƒ˜áƒ!");
        }

        if(!confirm(`áƒœáƒáƒ›áƒ“áƒ•áƒ˜áƒšáƒáƒ“ áƒ’áƒ¡áƒ£áƒ áƒ—: ${actionType}?`)) return;

        toggleLoading(true);
        try {
            if(actionType === 'buy') await addStock(q, pr, note);
            else await makeAction(actionType, q, pr, note);
            sendPush(currentUser + "-áƒ›áƒ áƒ“áƒáƒáƒ›áƒáƒ¢áƒ: " + q + " áƒ™áƒ’ (" + actionType + ")");

            clearInputs();
        } catch (e) {
            alert("áƒ¨áƒ”áƒªáƒ“áƒáƒ›áƒ áƒ›áƒáƒœáƒáƒªáƒ”áƒ›áƒ”áƒ‘áƒ˜áƒ¡ áƒ¨áƒ”áƒœáƒáƒ®áƒ•áƒ˜áƒ¡áƒáƒ¡!");
        }
        toggleLoading(false);
    }

    async function addStock(q, pr, note) {
        const p = document.getElementById('prod').value;
        const nStock = (Number(currentData.stock) || 0) + q;
        const nTotalVal = (Number(currentData.total_cost_value) || 0) + (q * pr);
        const nCost = nStock > 0 ? nTotalVal / nStock : 0;
        const ts = Date.now();

        await db.ref('inventory/' + p).update({ stock: nStock, total_cost_value: nTotalVal, cost: nCost });
        await db.ref('inventory/' + p + '/history').push({ 
            type: 'áƒ›áƒ˜áƒ¦áƒ”áƒ‘áƒ', qty: q, price: pr, note: note, 
            timestamp: ts, date: getFormattedTime(ts), saved_cost: nCost,
            user: currentUser 
        });
    }

    async function makeAction(type, q, pr, note) {
        const p = document.getElementById('prod').value;
        const currentCost = Number(currentData.cost) || 0;
        const ts = Date.now();
        
        let up = { stock: (Number(currentData.stock) || 0) - q };
        let entryType = '';

        if(type === 'sell') {
            up.total_cost_value = (Number(currentData.total_cost_value) || 0) - (currentCost * q);
            up.profit = (Number(currentData.profit) || 0) + (pr - currentCost) * q;
            up.revenue = (Number(currentData.revenue) || 0) + (pr * q);
            entryType = 'áƒ’áƒáƒ§áƒ˜áƒ“áƒ•áƒ';
        } else if(type === 'cons') {
            up.total_cost_value = (Number(currentData.total_cost_value) || 0) - (currentCost * q);
            up.debt = (Number(currentData.debt) || 0) + (pr * q);
            entryType = 'áƒ™áƒáƒœáƒ¡áƒ˜áƒ’áƒœáƒáƒªáƒ˜áƒ';
        } else if(type === 'expense') {
            up.stock = Number(currentData.stock) || 0;
            up.profit = (Number(currentData.profit) || 0) - q;
            entryType = 'áƒ®áƒáƒ áƒ¯áƒ˜';
        }

        await db.ref('inventory/' + p).update(up);
        await db.ref('inventory/' + p + '/history').push({ 
            type: entryType, qty: q, price: pr, note: note, 
            timestamp: ts, date: getFormattedTime(ts), saved_cost: currentCost,
            user: currentUser 
        });
    }

    function updateUI() {
        const rev = Number(currentData.revenue) || 0;
        const debt = Number(currentData.debt) || 0;
        const stock = Number(currentData.stock) || 0;
        const profit = Number(currentData.profit) || 0;
        
        document.getElementById('st-qty').innerText = stock.toFixed(1) + " áƒ™áƒ’";
        document.getElementById('st-rev').innerHTML = `
            <span style="font-size: 0.7em; opacity: 0.9; display: block;">áƒáƒ›áƒáƒœáƒáƒ’áƒ”áƒ‘áƒ˜</span>
            <b style="font-size: 1.2em; display: block;">${rev.toFixed(2)} â‚¾</b>
            <div style="font-size: 0.7em; opacity: 0.6; border-top: 1px solid rgba(255,255,255,0.1); margin-top: 2px;">áƒ¯áƒáƒ›áƒ˜: ${(rev+debt).toFixed(2)}</div>
        `;
        document.getElementById('total-summary').innerText = `áƒ¬áƒ›áƒ˜áƒœáƒ“áƒ áƒ›áƒáƒ’áƒ”áƒ‘áƒ: ${profit.toFixed(2)} â‚¾`;
        document.getElementById('debt-summary').innerText = `áƒ“áƒáƒ•áƒáƒšáƒ˜áƒáƒœáƒ”áƒ‘áƒ: ${debt.toFixed(2)} â‚¾ ğŸ”`;
        
        renderHistory();
        renderDailyStats();
    }

    function renderHistory() {
    const s = document.getElementById('histSearch').value.toLowerCase();
    
    let entries = Object.entries(currentData.history || {}).sort((a, b) => {
        // áƒ•áƒ˜áƒ§áƒ”áƒœáƒ”áƒ‘áƒ— b - a-áƒ¡, áƒ áƒáƒ› áƒáƒ®áƒáƒšáƒ˜ (áƒ“áƒ˜áƒ“áƒ˜ áƒ áƒ˜áƒªáƒ®áƒ•áƒ˜) áƒ˜áƒ§áƒáƒ¡ áƒáƒ˜áƒ áƒ•áƒ”áƒšáƒ˜
        const timeA = a[1].timestamp || 0;
        const timeB = b[1].timestamp || 0;
        return timeB - timeA;
    });

    if (!s) entries = entries.slice(0, visibleCount);

    
    // ... áƒ“áƒáƒœáƒáƒ áƒ©áƒ”áƒœáƒ˜ áƒ™áƒáƒ“áƒ˜ áƒ˜áƒ’áƒ˜áƒ•áƒ”áƒ

        
        let html = entries.map(([k, h]) => {
            if(s && !h.note.toLowerCase().includes(s) && !h.type.toLowerCase().includes(s)) return '';
            const total = (Number(h.qty) * Number(h.price)).toFixed(2);
            let tCls = h.type==='áƒ›áƒ˜áƒ¦áƒ”áƒ‘áƒ'?'type-buy':(h.type==='áƒ’áƒáƒ§áƒ˜áƒ“áƒ•áƒ'?'type-sell':(h.type==='áƒ™áƒáƒœáƒ¡áƒ˜áƒ’áƒœáƒáƒªáƒ˜áƒ'?'type-cons':(h.type==='áƒ®áƒáƒ áƒ¯áƒ˜'?'type-exp':'type-paid')));
            
            return `<div class="history-item">
                <b class="${tCls}">${h.type}</b>: ${h.qty}áƒ™áƒ’ Ã— ${h.price}â‚¾
                <div class="history-total">áƒ¯áƒáƒ›áƒ˜: ${total} â‚¾</div>
                <div style="font-size:10px;color:#666;margin-top:2px;">${h.date} | ${h.note || '-'} | ğŸ‘¤ ${h.user || 'áƒ£áƒªáƒœáƒáƒ‘áƒ˜'}</div>
                <div class="action-btns">
                    ${h.type==='áƒ™áƒáƒœáƒ¡áƒ˜áƒ’áƒœáƒáƒªáƒ˜áƒ'?`<button onclick="payDebt('${k}')">âœ…</button>`:''}
                ${isAdmin ? `<button onclick="editEntry('${k}')">âœï¸</button><button onclick="deleteEntry('${k}')">ğŸ—‘ï¸</button>` : ''}
            </div></div>`;
        }).join('');

        if (!s && entries.length >= visibleCount) {
            html += `<button onclick="visibleCount+=50; renderHistory();" style="margin-top:10px; background:#222; color:#aaa; border:1px solid #333;">áƒ›áƒ”áƒ¢áƒ˜áƒ¡ áƒ©áƒ•áƒ”áƒœáƒ”áƒ‘áƒ...</button>`;
        }
        document.getElementById('hist').innerHTML = html || "<div style='text-align:center; padding:20px; color:#555;'>áƒ˜áƒ¡áƒ¢áƒáƒ áƒ˜áƒ áƒªáƒáƒ áƒ˜áƒ”áƒšáƒ˜áƒ</div>";
    }

    function renderDailyStats() {
        const daily = {};
        Object.values(currentData.history || {}).forEach(h => {
            if(h.type === 'áƒ’áƒáƒ§áƒ˜áƒ“áƒ•áƒ' || h.type === 'áƒ’áƒáƒ“áƒáƒ®áƒ“áƒ˜áƒšáƒ˜áƒ') {
                const day = getDateOnly(h.timestamp);
                if(!daily[day]) daily[day] = { qty: 0, prof: 0 };
                daily[day].qty += Number(h.qty);
                daily[day].prof += (Number(h.price) - Number(h.saved_cost)) * Number(h.qty);
            }
        });

        const sortedDays = Object.keys(daily).sort((a,b) => {
             const [d1,m1,y1] = a.split('.'); const [d2,m2,y2] = b.split('.');
             return new Date(y2,m2-1,d2) - new Date(y1,m1-1,d1);
        }).slice(0, 5);
        
        document.getElementById('daily-stats-body').innerHTML = sortedDays.map(d => `
            <tr><td>${d}</td><td><b>${daily[d].qty.toFixed(1)}</b></td><td style="color:#38ef7d">+${daily[d].prof.toFixed(2)} â‚¾</td></tr>
        `).join('') || "<tr><td colspan='3' style='text-align:center; padding:10px;'>áƒ›áƒáƒœáƒáƒªáƒ”áƒ›áƒ”áƒ‘áƒ˜ áƒáƒ áƒáƒ</td></tr>";
    }

    async function payDebt(key) {
        if(!confirm("áƒ›áƒáƒ®áƒ“áƒ áƒ’áƒáƒ“áƒáƒ®áƒ“áƒ?")) return;
        const p = document.getElementById('prod').value;
        const h = currentData.history[key];
        await db.ref('inventory/' + p).update({
            debt: currentData.debt - (h.price * h.qty),
            profit: currentData.profit + ((h.price - h.saved_cost) * h.qty),
            revenue: currentData.revenue + (h.price * h.qty)
        });
        await db.ref('inventory/' + p + '/history/' + key).update({ type: 'áƒ’áƒáƒ“áƒáƒ®áƒ“áƒ˜áƒšáƒ˜áƒ', user: currentUser });
    }

    async function sendNotify(title, msg) {
        try { notifySound.play(); } catch(e){}
        if ('serviceWorker' in navigator && Notification.permission === "granted") {
            const reg = await navigator.serviceWorker.ready;
            reg.showNotification(title, { body: msg, icon: 'icon.png' });
        }
    }

    function clearInputs() { 
        document.getElementById('qty').value=""; 
        document.getElementById('price').value=""; 
        document.getElementById('note').value=""; 
    }

    function toggleModal(show) {
        document.getElementById('modal-overlay').style.display = show ? 'flex' : 'none';
        if(show) {
            const debts = {};
            Object.values(currentData.history || {}).forEach(h => {
                if(h.type === 'áƒ™áƒáƒœáƒ¡áƒ˜áƒ’áƒœáƒáƒªáƒ˜áƒ') {
                    const n = h.note || "áƒ£áƒªáƒœáƒáƒ‘áƒ˜";
                    debts[n] = (debts[n] || 0) + (h.price * h.qty);
                }
            });
            document.getElementById('modal-debt-list').innerHTML = Object.keys(debts).map(n => `
                <div style="display:flex;justify-content:space-between;padding:10px 0;border-bottom:1px solid #333;">
                    <span>${n}</span><b>${debts[n].toFixed(2)} â‚¾</b>
                </div>`).join('') || "áƒ•áƒáƒšáƒ”áƒ‘áƒ˜ áƒáƒ  áƒáƒ áƒ˜áƒ¡";
        }
    }
async function sendPush(txt) {
    const key = "os_v2_app_txarkvpxcvamzooqgocqimukjqcefmtkwrmefa5wdkorgd3rakdiabwpr52ywij54nvzz5ctzxfxqfc6orsyg6yovd3rmvnri6nadzq";
    const id = "9dc11555-f715-40cc-b9d0-338504328a4c";
    
    try {
        await fetch("https://onesignal.com/api/v1/notifications", {
            method: "POST",
            headers: {
                "Content-Type": "application/json; charset=utf-8",
                "Authorization": "Basic " + key
            },
            body: JSON.stringify({
                app_id: id,
                included_segments: ["Total Subscriptions"],
                headings: { "en": "Big Bif Pro" },
                contents: { "en": txt },
                // áƒ”áƒ¡ áƒáƒáƒ áƒáƒ›áƒ”áƒ¢áƒ áƒ”áƒ‘áƒ˜ áƒ£áƒ–áƒ áƒ£áƒœáƒ•áƒ”áƒšáƒ§áƒáƒ¤áƒ¡ áƒ›áƒ˜áƒ¬áƒáƒ“áƒ”áƒ‘áƒáƒ¡ áƒ“áƒáƒ®áƒ£áƒ áƒ£áƒš áƒ›áƒ“áƒ’áƒáƒ›áƒáƒ áƒ”áƒáƒ‘áƒáƒ¨áƒ˜
                web_push_priority: 10, 
                android_visibility: 1,
                priority: 10
            })
        });
    } catch (e) { 
        console.error("Push error:", e); 
    }
}






    async function deleteEntry(key, silent = false) {
        if(!silent && !confirm("áƒœáƒáƒ›áƒ“áƒ•áƒ˜áƒšáƒáƒ“ áƒ’áƒ¡áƒ£áƒ áƒ— áƒ¬áƒáƒ¨áƒšáƒ?")) return;
        try {
            const p = document.getElementById('prod').value;
            const h = currentData.history[key];
            if (!h) return;
            toggleLoading(true);
            const qty = Number(h.qty);
            const price = Number(h.price);
            const sc = Number(h.saved_cost);
            let up = { ...currentData }; delete up.history;

            if(h.type === 'áƒ›áƒ˜áƒ¦áƒ”áƒ‘áƒ') {
                up.stock = (Number(up.stock) || 0) - qty;
                up.total_cost_value = (Number(up.total_cost_value) || 0) - (qty * price);
                up.cost = up.stock > 0 ? up.total_cost_value / up.stock : 0;
            } else if(h.type === 'áƒ’áƒáƒ§áƒ˜áƒ“áƒ•áƒ' || h.type === 'áƒ’áƒáƒ“áƒáƒ®áƒ“áƒ˜áƒšáƒ˜áƒ') {
                up.stock = (Number(up.stock) || 0) + qty;
                up.total_cost_value = (Number(up.total_cost_value) || 0) + (sc * qty);
                up.profit = (Number(up.profit) || 0) - ((price - sc) * qty);
                up.revenue = (Number(up.revenue) || 0) - (price * qty);
            } else if(h.type === 'áƒ™áƒáƒœáƒ¡áƒ˜áƒ’áƒœáƒáƒªáƒ˜áƒ') {
                up.stock = (Number(up.stock) || 0) + qty;
                up.debt = (Number(up.debt) || 0) - (price * qty);
                up.total_cost_value = (Number(up.total_cost_value) || 0) + (sc * qty);
            } else if(h.type === 'áƒ®áƒáƒ áƒ¯áƒ˜') {
                up.profit = (Number(up.profit) || 0) + qty;
            }

            await db.ref('inventory/' + p).update(up);
            await db.ref('inventory/' + p + '/history/' + key).remove();
        } catch (err) { alert("áƒ¨áƒ”áƒªáƒ“áƒáƒ›áƒ áƒ¬áƒáƒ¨áƒšáƒ˜áƒ¡áƒáƒ¡"); }
        toggleLoading(false);
    }

    async function editEntry(key) {
        const h = currentData.history[key];
        if (!h) return;
        const nQ = prompt("áƒáƒ®áƒáƒšáƒ˜ áƒ áƒáƒáƒ“áƒ”áƒœáƒáƒ‘áƒ:", h.qty);
        if (nQ === null) return;
        const nP = prompt("áƒáƒ®áƒáƒšáƒ˜ áƒ¤áƒáƒ¡áƒ˜:", h.price);
        if (nP === null) return;
        const nN = prompt("áƒáƒ®áƒáƒšáƒ˜ áƒ¨áƒ”áƒœáƒ˜áƒ¨áƒ•áƒœáƒ:", h.note);
        if (nN === null) return;

        toggleLoading(true);
        await deleteEntry(key, true);
        const p = document.getElementById('prod').value;
        document.getElementById('qty').value = nQ;
        document.getElementById('price').value = nP;
        document.getElementById('note').value = nN;
        
        if (h.type === 'áƒ›áƒ˜áƒ¦áƒ”áƒ‘áƒ') await addStock(Number(nQ), Number(nP), nN);
        else {
            let typeKey = h.type === 'áƒ’áƒáƒ§áƒ˜áƒ“áƒ•áƒ' ? 'sell' : (h.type === 'áƒ™áƒáƒœáƒ¡áƒ˜áƒ’áƒœáƒáƒªáƒ˜áƒ' ? 'cons' : 'expense');
            await makeAction(typeKey, Number(nQ), Number(nP), nN);
        }
        clearInputs();
        toggleLoading(false);
    }

    function updateClientList() {
        if (!currentData || !currentData.history) return;
        const clientList = document.getElementById('clients');
        const uniqueClients = new Set();
        Object.values(currentData.history).forEach(h => { if (h.note) uniqueClients.add(h.note.trim()); });
        clientList.innerHTML = "";
        uniqueClients.forEach(name => {
            const option = document.createElement('option');
            option.value = name;
            clientList.appendChild(option);
        });
    }

    if ('serviceWorker' in navigator) {
    navigator.serviceWorker.register('OneSignalSDKWorker.js')
    .then(reg => console.log('Service Worker áƒ áƒ”áƒ’áƒ˜áƒ¡áƒ¢áƒ áƒ˜áƒ áƒ”áƒ‘áƒ£áƒšáƒ˜áƒ'))
    .catch(err => console.log('áƒ¨áƒ”áƒªáƒ“áƒáƒ›áƒ:', err));
}

    }
</script>

</body>
</html>
